<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- CONFIG UTAMA --- */
        :root { --primary: #4f46e5; --bg: #f3f4f6; --text: #1f2937; }
        body { background-color: var(--bg); font-family: 'Inter', sans-serif; color: var(--text); }
        .hidden { display: none !important; }

        /* --- LOGIN & PROJECT --- */
        .login-wrapper { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%); }
        .login-card { background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); width: 100%; max-width: 400px; }
        .project-card { background: white; border-radius: 12px; padding: 1.5rem; border: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s; height: 100%; }
        .project-card:hover { border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: translateY(-3px); }
        .btn-custom { background-color: var(--primary); color: white; border: none; padding: 10px 24px; border-radius: 8px; font-weight: 500; transition: 0.2s; }
        .btn-custom:hover { background-color: #4338ca; color: white; }
        .member-badge { display: inline-block; padding: 2px 6px; margin-right: 4px; margin-bottom: 4px; background-color: #f3f4f6; border-radius: 4px; font-size: 0.7rem; color: #4b5563; border: 1px solid #e5e7eb; }


        /* --- TASK CARD (FIXED UI) --- */
        .task-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: all 0.2s ease;
            
            display: flex;
            flex-direction: column;
            min-height: 200px; 
        }

        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.1);
        }

        /* Border Warna Status */
        .task-card.todo { border-top: 5px solid #3b82f6; } 
        .task-card.task-progress { border-top: 5px solid #f59e0b; background-color: #fffdf2; } 
        .task-card.done { border-top: 5px solid #10b981; opacity: 0.9; }

        .task-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem; color: #111827; margin-top: 10px; }
        .task-desc { font-size: 0.9rem; color: #6b7280; margin-bottom: 1.5rem; flex-grow: 1; }

        /* Admin Tools */
        .admin-tools { opacity: 0; transition: 0.2s; }
        .task-card:hover .admin-tools { opacity: 1; }
    </style>
</head>
<body>

    <nav id="navbar" class="navbar bg-white shadow-sm sticky-top hidden">
        <div class="container">
            <span class="navbar-brand fw-bold" style="color: var(--primary);"><i class="fas fa-layer-group me-2"></i>Task Manager</span>
            <div class="d-flex align-items-center">
                <div class="me-3 text-end"><div class="fw-bold small" id="nav-email">User</div><div class="small text-muted" style="font-size:0.7rem;" id="nav-role">Role</div></div>
                <button class="btn btn-sm btn-outline-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <div id="login-section" class="login-wrapper">
        <div class="login-card">
            <h4 class="fw-bold text-center mb-4">Selamat Datang</h4>
            <div class="alert alert-info small p-2"><b>Admin:</b> admin@gmail.com<br><b>User:</b> user@gmail.com</div>
            <form onsubmit="handleLogin(event)">
                <div class="mb-3"><input type="email" id="email" class="form-control p-3" placeholder="Email" required></div>
                <div class="mb-4"><input type="password" id="password" class="form-control p-3" placeholder="Password" required></div>
                <button type="submit" class="btn btn-custom w-100">Masuk</button>
            </form>
        </div>
    </div>

    <div id="dashboard-section" class="container py-5 hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div><h2 class="fw-bold">Projects</h2><p class="text-muted">Ruang kerja tim Anda</p></div>
            <button id="btn-add-project" class="btn btn-custom" onclick="modalProject.show()"><i class="fas fa-plus me-2"></i>Project Baru</button>
        </div>
        <div id="project-list" class="row g-4"></div>
        
        <div id="pagination-info" class="text-center mt-4 text-muted small"></div>
    </div>

    <div id="task-section" class="container py-4 hidden">
        <div class="d-flex align-items-center mb-4 pb-3 border-bottom">
            <button class="btn btn-light me-3" onclick="showDashboard()"><i class="fas fa-arrow-left"></i> Kembali</button>
            <h4 class="m-0 fw-bold" id="project-title">Nama Project</h4>
            <button id="btn-add-task" class="btn btn-custom ms-auto" onclick="resetModalTask(); modalTask.show()"><i class="fas fa-plus me-2"></i>Tambah Task</button>
        </div>
        <div class="row">
            <div class="col-md-4"><div class="p-3 bg-light rounded h-100"><h6 class="text-primary fw-bold mb-3 border-bottom pb-2">TO DO</h6><div id="col-todo"></div></div></div>
            <div class="col-md-4"><div class="p-3 bg-light rounded h-100"><h6 class="text-warning fw-bold mb-3 border-bottom pb-2">IN PROGRESS</h6><div id="col-progress"></div></div></div>
            <div class="col-md-4"><div class="p-3 bg-light rounded h-100"><h6 class="text-success fw-bold mb-3 border-bottom pb-2">DONE</h6><div id="col-done"></div></div></div>
        </div>
    </div>

    <div class="modal fade" id="modalProject" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4 border-0 shadow"><h5 class="fw-bold mb-3">Project Baru</h5><input id="inpPName" class="form-control mb-3" placeholder="Nama"><textarea id="inpPDesc" class="form-control mb-3" placeholder="Deskripsi"></textarea><button class="btn btn-custom w-100" onclick="createProject()">Simpan</button></div></div></div>
    <div class="modal fade" id="modalTask" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4 border-0 shadow"><h5 class="fw-bold mb-3">Task Editor</h5><input id="inpTTitle" class="form-control mb-3" placeholder="Judul"><textarea id="inpTDesc" class="form-control mb-3" placeholder="Deskripsi"></textarea><button class="btn btn-custom w-100" onclick="createTask()">Simpan</button></div></div></div>
    <div class="modal fade" id="modalInvite" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4 border-0 shadow"><h5 class="fw-bold mb-3">Undang Member</h5><input id="inpInviteEmail" class="form-control mb-3" placeholder="user@gmail.com"><button class="btn btn-custom w-100" onclick="saveInvite()">Kirim</button></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API = 'http://54.88.142.129:3000/api';
        const ADMIN_EMAIL = 'admin@gmail.com'; 

        let token = localStorage.getItem('token');
        let myEmail = localStorage.getItem('myEmail');
        let curPid = null, curInvitePid = null;
        let modalProject, modalTask, modalInvite;
        let editTaskId = null;

        document.addEventListener('DOMContentLoaded', () => {
            modalProject = new bootstrap.Modal('#modalProject');
            modalTask = new bootstrap.Modal('#modalTask');
            modalInvite = new bootstrap.Modal('#modalInvite');
            if(token && myEmail) showDashboard(); else showLogin();
        });

        // NAVIGATION
        function hideAll() { ['login-section','dashboard-section','task-section','navbar'].forEach(id => document.getElementById(id).classList.add('hidden')); }
        function showLogin() { hideAll(); document.getElementById('login-section').classList.remove('hidden'); }

    function showDashboard() {
    hideAll(); 
    document.getElementById('navbar').classList.remove('hidden'); 
    document.getElementById('dashboard-section').classList.remove('hidden');
    document.getElementById('nav-email').innerText = myEmail;
    
    const isAdmin = (myEmail === ADMIN_EMAIL);
    document.getElementById('nav-role').innerText = isAdmin ? 'Admin' : 'User';
    
    // ATURAN KRITIS 1: Hanya Admin yang boleh melihat tombol Project Baru
    document.getElementById('btn-add-project').style.display = isAdmin ? 'block' : 'none'; 
    
    loadProjects();
}
    async function createProject() {
    // ATURAN KRITIS 2: Cek di Frontend. Jika bukan admin, beri peringatan (Walaupun Backend yang akan memblokir).
    if (myEmail !== ADMIN_EMAIL) {
         return alert("Akses Ditolak: Hanya Admin yang dapat membuat Project baru.");
    }

    const name = document.getElementById('inpPName').value; 
    const description = document.getElementById('inpPDesc').value;
    
    if (!name) return alert("Nama Project harus diisi!");
}
        function showTaskBoard(pid, name) {
            curPid = pid; hideAll(); document.getElementById('navbar').classList.remove('hidden'); document.getElementById('task-section').classList.remove('hidden');
            document.getElementById('project-title').innerText = name;
            document.getElementById('btn-add-task').style.display = (myEmail === ADMIN_EMAIL) ? 'block' : 'none';
            loadTasks();
        }

        // LOGIC
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value.toLowerCase().trim(); 
            const password = document.getElementById('password').value;

            try {
                const res = await fetch(`${API}/auth/login`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({email, password}) 
                });

                const data = await res.json();
                
                if(data.success) { 
                    token = data.token; 
                    myEmail = email; 
                    localStorage.setItem('token', token); 
                    localStorage.setItem('myEmail', myEmail); 
                    showDashboard(); 
                } 
                else { 
                    // Jika login gagal (termasuk validasi sederhana dari backend)
                    alert(data.message); 
                }
            } catch(e) { 
                alert("Server Error"); 
            }
        }
        
        // --- LOGOUT FINAL FIX ---
        function logout() { 
            localStorage.removeItem('token');
            localStorage.removeItem('myEmail');
            
            token = null; 
            myEmail = null;
            
            showLogin(); 
        }

        //LOAD PROJECTS 
        async function loadProjects(search = '') {
            const list = document.getElementById('project-list');
            list.innerHTML = '<div class="text-center w-100 py-5"><div class="spinner-border text-primary"></div></div>';
            
            try {
                const res = await fetch(`${API}/projects?search=${search}&limit=10`, { 
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if(res.status === 401) return logout();
                const data = await res.json();
                
                // --- CHECK KRITIS (Data Integrity) ---
                if (!data.success || !data.data || !Array.isArray(data.data.projects)) {
                     const errorMsg = data.message || "Respon data tidak valid atau Token Expired. Cek console log.";
                     list.innerHTML = `<div class="alert alert-danger">Gagal memuat data: ${errorMsg}</div>`;
                     console.error("API Response Error:", data);
                     return;
                }
                // --- AKHIR CHECK KRITIS ---
                
                list.innerHTML = ''; 
                const currentRole = document.getElementById('nav-role').innerText;
                const isAdmin = (currentRole === 'Admin'); 

                // Check innerText (Mencegah error 'reading innerText')
                const paginationInfo = document.getElementById('pagination-info');
                if(paginationInfo) { 
                    if(data.pagination && data.data.projects.length > 0) {
                        paginationInfo.innerText = 
                            `Menampilkan ${data.data.projects.length} dari ${data.pagination.total_records} project`;
                    } else {
                        paginationInfo.innerText = '';
                    }
                }

                let visibleCount = 0;

                // RENDERING LOGIC RESTORED
                data.data.projects.forEach(p => { 
                    const ownerEmail = p.owner?.email || 'Unknown'; 
                    const isOwner = (ownerEmail === myEmail);
                    visibleCount++;
                    
                    let badge = '';
                    let adminTools = '';

                    // LOGIC HAK AKSES UNTUK TOMBOL/BADGE
                    if (isOwner || isAdmin) {
                        badge = '<span class="badge bg-primary">Owner/Admin</span>';
                        adminTools = `
                        <div class="mt-3 d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm flex-grow-1" onclick="event.stopPropagation(); openInvite(${p.id})">Invite</button>
                            <button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); deleteProject(${p.id})">Hapus</button>
                        </div>`;
                    } else {
                        badge = '<span class="badge bg-success">Member Team</span>';
                        adminTools = '<div class="mt-3 text-muted small fst-italic text-center">View Only Access</div>';
                    }

                    // Render Member
                    let memberHtml = '';
                    if (p.members && p.members.length > 0) {
                        p.members.forEach(m => {
                            const memEmail = m.user?.email || 'Unknown';
                            memberHtml += `<span class="member-badge">${memEmail}</span>`;
                        });
                    } else {
                        memberHtml = '<small class="text-muted fst-italic" style="font-size:0.75rem">Belum ada member lain</small>';
                    }

                    // Render HTML Kartu
                    list.innerHTML += `
                    <div class="col-md-4">
                        <div class="project-card d-flex flex-column" onclick="showTaskBoard(${p.id}, '${p.name}')">
                            <div class="d-flex justify-content-between mb-2">
                                <div style="width:40px; height:40px; background:#e0e7ff; border-radius:8px; display:flex; align-items:center; justify-content:center; color:var(--primary); font-size:1.2rem;"><i class="fas fa-folder"></i></div>
                                ${badge}
                            </div>
                            <h5 class="fw-bold mb-1">${p.name}</h5>
                            <p class="text-muted small mb-3 flex-grow-1">${p.description || '-'}</p>
                            <div class="border-top pt-2 mb-2 flex-grow-1">
                                <small class="d-block text-secondary mb-1" style="font-size:0.7rem">Owner: ${ownerEmail}</small>
                                ${memberHtml}
                            </div>
                            ${adminTools}
                        </div>
                    </div>`;
                });
                
                if(visibleCount === 0) list.innerHTML = `<div class="col-12 text-center py-5 text-muted">Belum ada project.</div>`;
                
            } catch(e) { 
                console.error("Error Load Projects:", e);
                list.innerHTML = `<div class="alert alert-danger">Gagal memuat data (Check Console): ${e.message}</div>`;
            }
        }
        
        async function createProject() {
            const name = document.getElementById('inpPName').value; 
            const description = document.getElementById('inpPDesc').value;
            
            if (!name) return alert("Nama Project harus diisi!");

            try {
                const res = await fetch(`${API}/projects`, { 
                    method: 'POST', 
                    headers: {'Content-Type':'application/json', 'Authorization': `Bearer ${token}`}, 
                    body: JSON.stringify({name, description}) 
                });
                
                const data = await res.json();

                if (data.success) {
                    alert("Project berhasil dibuat!");
                    document.getElementById('inpPName').value = '';
                    document.getElementById('inpPDesc').value = '';
                    modalProject.hide(); 
                    loadProjects(); 
                } else {
                    console.error("Gagal Create:", data);
                    
                    if (data.errors && Array.isArray(data.errors)) {
                        const errorMsg = data.errors.map(e => `- ${e.message}`).join('\n');
                        alert("Gagal membuat project:\n" + errorMsg);
                    } else {
                        alert("Gagal: " + data.message);
                    }
                }
            } catch (err) {
                console.error(err);
                alert("Terjadi kesalahan koneksi ke server.");
            }
        } 
        
        async function deleteProject(pid) { 
            if(confirm("Apakah Anda yakin ingin menghapus Project ini?")) { 
                try {
                    const res = await fetch(`${API}/projects/${pid}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    const data = await res.json();

                    if (res.ok) { 
                        alert(data.message || "Project berhasil dihapus!");
                        loadProjects(); 
                    } else {
                        alert("Gagal menghapus: " + data.message);
                    }
                } catch (error) {
                    alert("Terjadi kesalahan koneksi.");
                }
            } 
        } 
        
        function openInvite(pid) { curInvitePid=pid; document.getElementById('inpInviteEmail').value=''; modalInvite.show(); }

        async function saveInvite() {
            const email = document.getElementById('inpInviteEmail').value.toLowerCase().trim();
            if(!email) return alert("Email wajib diisi");

            try {
                const res = await fetch(`${API}/projects/${curInvitePid}/invite`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ email })
                });

                const data = await res.json();

                if (res.ok) {
                    alert(data.message || `Berhasil mengundang ${email}`);
                    modalInvite.hide();
                    loadProjects(); 
                } else {
                    alert("Gagal mengundang: " + data.message);
                }
            } catch(err) {
                alert("Terjadi kesalahan koneksi ke server.");
            }
        }

        // TASK LOAD
        async function loadTasks() {
            ['col-todo','col-progress','col-done'].forEach(i => document.getElementById(i).innerHTML = '');
            const res = await fetch(`${API}/projects/${curPid}/tasks`, { headers: { 'Authorization': `Bearer ${token}` }});
            const data = await res.json();
            const isAdmin = (myEmail === ADMIN_EMAIL);

            if (!data.data || !Array.isArray(data.data.tasks)) {
                 document.getElementById('col-todo').innerHTML = `<div class="alert alert-warning small">Gagal memuat task.</div>`;
                 return;
            }

            data.data.tasks.forEach(t => {
                let statusClass = 'todo';
                let badge = 'To Do';
                let btnColor = 'btn-outline-primary';
                let btnText = 'Mulai';
                let nextStatus = 'IN_PROGRESS';

                if(t.status === 'IN_PROGRESS') {
                    statusClass = 'task-progress'; 
                    badge = 'On Progress';
                    btnColor = 'btn-warning text-white';
                    btnText = 'Selesai';
                    nextStatus = 'DONE';
                } else if(t.status === 'DONE') {
                    statusClass = 'done';
                    badge = 'Done';
                }

                const safeTitle = t.title.replace(/'/g, "\\'"); 
                const safeDesc = (t.description || '').replace(/'/g, "\\'");
                
                const adminTools = isAdmin ? `
                    <div class="admin-tools">
                        <i class="fas fa-pen text-secondary me-3" style="cursor:pointer" onclick="editTask(${t.id}, '${safeTitle}', '${safeDesc}')"></i>
                        <i class="fas fa-trash text-danger" style="cursor:pointer" onclick="deleteTask(${t.id})"></i>
                    </div>` : '';
                
                let actionBtn = t.status !== 'DONE' ? 
                    `<button class="btn btn-sm ${btnColor} w-100 mt-auto" onclick="moveTask(${t.id}, '${nextStatus}')">${btnText}</button>` : 
                    `<div class="text-center text-success fw-bold small mt-auto">âœ“ Tuntas</div>`;

                const html = `
                <div class="task-card ${statusClass}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="badge bg-secondary bg-opacity-10 text-dark border">${badge}</span>
                        ${adminTools}
                    </div>
                    <div class="task-title">${t.title}</div>
                    <div class="task-desc">${t.description || 'Tidak ada deskripsi.'}</div>
                    ${actionBtn}
                </div>`;

                if(t.status==='TODO') document.getElementById('col-todo').innerHTML += html;
                else if(t.status==='IN_PROGRESS') document.getElementById('col-progress').innerHTML += html;
                else document.getElementById('col-done').innerHTML += html;
            });
        }

        async function createTask() { const title=document.getElementById('inpTTitle').value; const description=document.getElementById('inpTDesc').value; await fetch(`${API}/projects/${curPid}/tasks`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({title,description})}); modalTask.hide(); loadTasks(); }
        async function moveTask(id, status) { await fetch(`${API}/tasks/${id}`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({status})}); loadTasks(); }
        async function deleteTask(tid) { if(confirm("Hapus Task?")) { await fetch(`${API}/tasks/${tid}`,{method:'DELETE',headers:{'Authorization':`Bearer ${token}`}}); loadTasks(); } }
        function editTask(id, t, d) { editTaskId=id; document.getElementById('inpTTitle').value=t; document.getElementById('inpTDesc').value=d; const btn=document.querySelector('#modalTask .btn-custom'); btn.innerText="Update"; btn.onclick=saveEditTask; modalTask.show(); }
        async function saveEditTask() { const title=document.getElementById('inpTTitle').value; const description=document.getElementById('inpTDesc').value; await fetch(`${API}/tasks/${editTaskId}`,{method:'PATCH',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({title,description})}); modalTask.hide(); loadTasks(); resetModalTask(); }
        function resetModalTask() { document.getElementById('inpTTitle').value=''; document.getElementById('inpTDesc').value=''; const btn=document.querySelector('#modalTask .btn-custom'); btn.innerText="Simpan"; btn.onclick=createTask; }
    </script>
</body>
</html>